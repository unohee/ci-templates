# Reusable Python CI Workflow
# Usage:
#   jobs:
#     ci:
#       uses: unohee/ci-templates/.github/workflows/python-ci.yml@main
#       with:
#         python-version: '3.12'
#         src-path: 'src/'
#       secrets: inherit

name: Python CI (Reusable)

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.12'
      src-path:
        description: 'Source code directory'
        required: false
        type: string
        default: 'src/'
      test-path:
        description: 'Test directory'
        required: false
        type: string
        default: 'tests/unit/'
      coverage-threshold:
        description: 'Minimum coverage percentage'
        required: false
        type: number
        default: 0
      max-line-count:
        description: 'Maximum lines per file (LOC gate)'
        required: false
        type: number
        default: 800
      enable-fake-data-check:
        description: 'Enable fake data pattern detection'
        required: false
        type: boolean
        default: true
      feature-patterns:
        description: 'Feature variable patterns to check (comma-separated)'
        required: false
        type: string
        default: 'feature,program,arbitrage'
      strict-fake-data:
        description: 'Treat warnings as errors for fake data check'
        required: false
        type: boolean
        default: false

jobs:
  fake-data-check:
    name: Fake Data Detection
    runs-on: ubuntu-latest
    if: ${{ inputs.enable-fake-data-check }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Checkout ci-templates
        uses: actions/checkout@v4
        with:
          repository: unohee/ci-templates
          path: .ci-templates

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Run Fake Data Detector
        env:
          FAKE_DATA_FEATURE_PATTERNS: ${{ inputs.feature-patterns }}
        run: |
          if [ "${{ inputs.strict-fake-data }}" = "true" ]; then
            python .ci-templates/scripts/fake_data_detector.py ${{ inputs.src-path }} --ci --strict
          else
            python .ci-templates/scripts/fake_data_detector.py ${{ inputs.src-path }} --ci
          fi

      - name: Check np.random in feature code
        run: |
          echo "ðŸ” Checking for np.random in feature generation..."
          FAILED=0

          # Convert feature patterns to grep pattern
          PATTERNS="${{ inputs.feature-patterns }}"
          GREP_PATTERN=$(echo "$PATTERNS" | tr ',' '|')

          if [ -d "${{ inputs.src-path }}" ]; then
            # Exclude test files and comments
            if grep -rn "np\.random\.\(rand\|randn\|uniform\|normal\)" "${{ inputs.src-path }}" \
               --include="*.py" \
               --exclude-dir="__pycache__" \
               --exclude="*test*.py" 2>/dev/null | \
               grep -v "#" | \
               grep -v "seed" | \
               grep -v "random_state" | \
               grep -E "($GREP_PATTERN)" 2>/dev/null; then
              echo "::error::Found np.random usage in feature generation code"
              FAILED=1
            fi
          fi

          if [ $FAILED -eq 1 ]; then
            echo "âŒ Fake data patterns detected!"
            echo "Please use real API data instead of np.random for features."
            exit 1
          else
            echo "âœ… No fake data patterns found"
          fi

      - name: Cleanup
        if: always()
        run: rm -rf .ci-templates

  lint:
    name: Code Quality (Lint & Format)
    runs-on: ubuntu-latest
    needs: [fake-data-check]
    if: always() && (needs.fake-data-check.result == 'success' || needs.fake-data-check.result == 'skipped')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
          cache: 'pip'

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff black bandit[toml]

      - name: Run Ruff linter
        run: |
          ruff check ${{ inputs.src-path }} --output-format=github
        continue-on-error: true

      - name: Run Black formatter check
        run: |
          black --check ${{ inputs.src-path }}
        continue-on-error: true

      - name: Run Bandit security check
        run: |
          bandit -r ${{ inputs.src-path }} -ll || true

  test:
    name: Tests & Coverage
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          pip install pytest pytest-cov pytest-asyncio pytest-mock pytest-timeout

      - name: Run tests with coverage
        id: pytest
        run: |
          pytest ${{ inputs.test-path }} \
            --cov=${{ inputs.src-path }} \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-report=json \
            --cov-fail-under=${{ inputs.coverage-threshold }} \
            --tb=short \
            --timeout=60 \
            -q \
            2>&1 | tee pytest_output.txt || true

          PASSED=$(grep -oP '\d+(?= passed)' pytest_output.txt | tail -1 || echo "0")
          FAILED=$(grep -oP '\d+(?= failed)' pytest_output.txt | tail -1 || echo "0")
          SKIPPED=$(grep -oP '\d+(?= skipped)' pytest_output.txt | tail -1 || echo "0")

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT

      - name: Extract coverage percentage
        id: coverage
        run: |
          if [ -f coverage.json ]; then
            COVERAGE=$(python -c "import json; print(round(json.load(open('coverage.json'))['totals']['percent_covered'], 1))")
            echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
          else
            echo "percentage=0" >> $GITHUB_OUTPUT
          fi

      - name: Test Summary
        run: |
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | ${{ steps.pytest.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | ${{ steps.pytest.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skipped | ${{ steps.pytest.outputs.skipped }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | ${{ steps.coverage.outputs.percentage }}% |" >> $GITHUB_STEP_SUMMARY

  type-check:
    name: Type Checking (mypy)
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mypy types-requests types-PyYAML
          if [ -f requirements.txt ]; then pip install -r requirements.txt || true; fi

      - name: Run mypy
        run: |
          mypy ${{ inputs.src-path }} --ignore-missing-imports --no-strict-optional || true

  loc-gate:
    name: LOC Gate (Max ${{ inputs.max-line-count }} lines)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check file line counts
        run: |
          echo "### LOC Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FAILED=0
          for file in $(find ${{ inputs.src-path }} -name "*.py" -type f); do
            lines=$(wc -l < "$file")
            if [ "$lines" -gt ${{ inputs.max-line-count }} ]; then
              echo "| $file | $lines | FAIL |" >> $GITHUB_STEP_SUMMARY
              FAILED=1
            fi
          done

          if [ "$FAILED" -eq 1 ]; then
            echo "::error::Files exceed ${{ inputs.max-line-count }} line limit"
            exit 1
          fi

          echo "All files under ${{ inputs.max-line-count }} lines" >> $GITHUB_STEP_SUMMARY

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [fake-data-check, lint, test, type-check, loc-gate]
    if: always()

    steps:
      - name: Quality summary
        run: |
          echo "### Quality Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Fake Data | ${{ needs.fake-data-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check | ${{ needs.type-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| LOC Gate | ${{ needs.loc-gate.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Check critical failures
        run: |
          if [ "${{ needs.fake-data-check.result }}" = "failure" ]; then
            echo "::error::Fake data check failed - this blocks the pipeline"
            exit 1
          fi
